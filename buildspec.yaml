version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies"
      - pip install --upgrade awscli
      - yum install -y jq  # Required for generate-config.sh

  pre_build:
    commands:
      - echo "Deploying to environment $DEPLOY_ENV"
      - if [[ -z "$DEPLOY_ENV" ]]; then
          echo "DEPLOY_ENV not set. Aborting deployment.";
          exit 1;
        fi
      - echo "Setting environment variables" 
      - echo $DEPLOY_ENV "is the environment"
      - export ENV=$DEPLOY_ENV
      
      # Fetch pipeline configuration
      - echo "Fetching pipeline configuration from Parameter Store"
      - export TARGET_BUCKET=$(aws ssm get-parameter --name /spooky-decs/admin/$ENV/s3-bucket --query 'Parameter.Value' --output text)
      - export DISTRIBUTION_ID=$(aws ssm get-parameter --name /spooky-decs/admin/$ENV/cf-distribution --query 'Parameter.Value' --output text)
      - echo "Will deploy to $TARGET_BUCKET with CloudFront $DISTRIBUTION_ID"
      
      # Generate application config.json
      - echo "Generating config.json from Parameter Store"
      - chmod +x generate-config.sh
      - ./generate-config.sh $ENV
      
      # VERIFY config.json was created
      - echo "Verifying config.json exists..."
      - if [ ! -f config.json ]; then
          echo "ERROR - config.json was not generated!";
          exit 1;
        fi
      - echo "✅ config.json exists"
      - ls -lh config.json
      - echo "Preview of config.json:"
      - cat config.json | jq '.' || cat config.json
      - echo ""

  build:
    commands:
      - echo "Syncing files to S3"
      - aws s3 sync . s3://$TARGET_BUCKET --delete --exclude ".git/*" --exclude "buildspec.yml" --exclude ".gitignore" --exclude "README.md" --exclude "test.txt" --exclude "generate-config.sh"
      - echo "S3 sync complete"
      
      # VERIFY config.json was uploaded
      - echo "Verifying config.json was uploaded to S3..."
      - aws s3 ls s3://$TARGET_BUCKET/config.json
      - echo "✅ config.json confirmed in S3"

  post_build:
    commands:
      - echo "Creating CloudFront invalidation"
      - aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
      - echo "✅ Deployment complete"

artifacts:
  files:
    - '**/*'