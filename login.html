<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SpookyDecs Admin Login</title>
<style>
  /* kept dark, compact styling you liked */
  body { font-family: Arial, sans-serif; background:#111; color:#f4f4f4; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
  .login-container { background: rgba(34,34,34,0.95); border:2px solid #f47c3c; border-radius:10px; padding:36px; width:340px; box-shadow:0 0 20px rgba(255,140,0,0.25); text-align:center; }
  h2 { margin:0 0 18px; color:#f47c3c; font-size:1.25rem; }
  input { width: 92%; padding:10px; margin:10px 0; border-radius:6px; border:1px solid #444; background:#222; color:#fff; }
  button { width:95%; padding:10px; margin-top:8px; background:#f47c3c; color:#111; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
  button:hover { background:#ff9248; }
  .error { color:#ff6666; font-size:0.9rem; margin-top:10px; min-height:1.2em; }
  .small { font-size:0.85rem; color:#bbb; margin-top:8px; }
  .link { color:#cfcfcf; text-decoration:underline; cursor:pointer; font-size:0.85rem; display:block; margin-top:8px; }
</style>
</head>
<body>

  <div class="login-container" role="main">
    <h2>SpookyDecs Admin Login</h2>

    <input id="username" type="text" placeholder="Username" autocomplete="username" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    <button id="loginBtn">Sign In</button>

    <div id="errorMsg" class="error" aria-live="polite"></div>
    <div class="small">You will be returned to the admin site after a successful sign-in.</div>
    <div class="link" id="help">Need help? Contact admin</div>
  </div>

  <!-- Cognito SDK -->
  <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@5.2.7/dist/amazon-cognito-identity.min.js"></script>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const USER_POOL_ID = 'us-east-2_BnxSu5LEt';
    const CLIENT_ID    = '11er9f8qa7jkvgelm6hernb2ed';

    // Determine environment and default return URL (admin root)
    const hostname = window.location.hostname.toLowerCase();
    const isDev = hostname.includes('dev-') || hostname.includes('dev.');
    const adminRoot = isDev ? 'https://dev-admin.spookydecs.com' : 'https://admin.spookydecs.com';

    // Parse optional returnUrl param (use it if present and safe)
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    const requestedReturn = getQueryParam('returnUrl');
    const returnUrl = requestedReturn && requestedReturn.startsWith('http') ? requestedReturn : adminRoot;

    // UI refs
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const errorMsg = document.getElementById('errorMsg');

    errorMsg.textContent = '';

    // helper: display errors and log
    function showError(msg, err) {
      console.error(msg, err || '');
      errorMsg.textContent = msg;
    }

    // Token storage key
    const TOKEN_KEY = 'spookydecs_id_token';
    const USER_KEY = 'spookydecs_username';

    // ---------- Cognito objects ----------
    const poolData = { UserPoolId: USER_POOL_ID, ClientId: CLIENT_ID };
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

    // submit on Enter
    [usernameEl, passwordEl].forEach(el => el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') login();
    }));

    loginBtn.addEventListener('click', login);

    function login() {
      errorMsg.textContent = '';

      const username = usernameEl.value && usernameEl.value.trim();
      const password = passwordEl.value && passwordEl.value.trim();

      if (!username || !password) {
        showError('Please enter both username and password.');
        return;
      }

      const authDetails = new AmazonCognitoIdentity.AuthenticationDetails({
        Username: username,
        Password: password
      });

      const userData = { Username: username, Pool: userPool };
      const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      cognitoUser.authenticateUser(authDetails, {
        onSuccess: (result) => {
          try {
            const idToken = result.getIdToken().getJwtToken();
            // Save token + username in localStorage for site auth checks
            localStorage.setItem(TOKEN_KEY, idToken);
            localStorage.setItem(USER_KEY, username);

            // Redirect back to admin root (or requested returnUrl)
            window.location.href = returnUrl;
          } catch (e) {
            showError('Unexpected auth result. Check console.');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
            console.error(e);
          }
        },

        onFailure: (err) => {
          let message = 'Login failed. Please try again.';
          if (err && err.code === 'NotAuthorizedException') message = 'Incorrect username or password.';
          if (err && err.code === 'UserNotFoundException') message = 'User does not exist.';
          if (err && err.message) message = err.message;
          showError(message, err);
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
        },

        // Handle forced new password challenge
        newPasswordRequired: (userAttributes, requiredAttributes) => {
          // remove attributes the SDK adds that can't be modified
          delete userAttributes.email_verified;

          const newPassword = prompt('New password required. Enter a new password: (min length enforced by pool)');
          if (!newPassword) {
            showError('New password required to continue.');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
            return;
          }

          cognitoUser.completeNewPasswordChallenge(newPassword, userAttributes, {
            onSuccess: (result) => {
              const idToken = result.getIdToken().getJwtToken();
              localStorage.setItem(TOKEN_KEY, idToken);
              localStorage.setItem(USER_KEY, username);
              window.location.href = returnUrl;
            },
            onFailure: (err) => {
              showError('Failed to set new password. ' + (err.message || ''));
              loginBtn.disabled = false;
              loginBtn.textContent = 'Sign In';
            }
          });
        }
      });
    }

    // Optional: if user is already authenticated, send to admin root immediately
    (function autoRedirectIfTokenValid() {
      try {
        const raw = localStorage.getItem(TOKEN_KEY);
        if (!raw) return;
        const payload = JSON.parse(atob(raw.split('.')[1]));
        const now = Math.floor(Date.now() / 1000);
        if (payload && payload.exp && payload.exp > now + 30) {
          // token still valid -> go to admin root (or requested returnUrl)
          window.location.href = returnUrl;
        }
      } catch (e) { /* ignore and allow login */ }
    })();

  })();
  </script>
</body>
</html>
