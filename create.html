<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Create Item - Admin Dashboard</title>
<style>
  /* ---------- Global ---------- */
body {
  font-family: Arial, sans-serif;
  background-color: #1a1a1a;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  flex-direction: column;
  color: #f0f0f0;
}
.container {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: calc(100vh - 150px);
  margin: 0 auto;
  position: relative;
}

/* ---------- Header ---------- */
header { width: 100%; box-sizing: border-box; background-color: #2e2e2e; color: #fff; padding: 15px 40px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #888; position:relative; }
header .logo-title { display:flex; align-items:center; gap:12px; }
header h1 { margin:0; font-size:1.4rem; color:#ccc; }
header img.icon { height:40px; animation: floatIcon 3s ease-in-out infinite alternate; }
header .spiderweb { height:40px; }
header .header-links { display:flex; align-items:center; gap:12px; }
header button { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; background:#007bff; color:#fff; }
header button:hover { opacity:0.9; }

/* ---------- Hamburger ---------- */
.hamburger { display:none; flex-direction:column; justify-content:space-between; width:24px; height:18px; cursor:pointer; }
.hamburger div { height:3px; background:#fff; border-radius:2px; }
.offcanvas { position:fixed; top:0; left:-260px; width:260px; height:100%; background:#2e2e2e; color:#fff; transition:left 0.3s ease; padding:20px; display:flex; flex-direction:column; gap:20px; z-index:1000; }
.offcanvas.open { left:0; }
.offcanvas a, .offcanvas button { color:#fff; text-decoration:none; background:none; border:none; text-align:left; font-size:1rem; cursor:pointer; }
.offcanvas .footer { font-size:0.8rem; color:#ccc; margin-top:auto; }

/* ---------- Create & Preview Cards ---------- */
#createCard { 
  background: #2b2b2b; 
  padding: 25px 20px; 
  border-radius: 12px; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
  display:flex; 
  flex-direction:column; 
  gap:15px; 
  width:100%; 
  max-width:600px; 
}

/* Preview Modal */
#previewCard {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #2b2b2b;
  padding: 35px 25px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.7);
  flex-direction: column;
  gap: 20px;
  width: 90%;
  max-width: 650px;
  z-index: 10000;
}

/* Modal overlay background */
#modalOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
}

#createCard h2, #previewCard h2 { text-align:center; margin-bottom:15px; color:#ff7518; text-shadow:1px 1px 2px #000; }

.field-row { margin-bottom:14px; display:flex; flex-direction:column; }
.field-label { font-weight:600; margin-bottom:6px; text-align:left; color:#fff; }
input, select { padding:10px; border-radius:4px; border:1px solid #555; width:100%; box-sizing:border-box; background-color:#1f1f1f; color:#fff; }

.button-row { display:flex; justify-content:center; gap:12px; margin-top:20px; }
button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition: transform 0.15s ease; }
button:hover:not(:disabled) { transform:scale(1.05); }
button:disabled { opacity:0.6; cursor:not-allowed; }
.btn-primary { background: linear-gradient(45deg, #ff7518, #ffb347); color:#fff; box-shadow:0 3px 6px rgba(0,0,0,0.3); }
.btn-danger { background: linear-gradient(45deg, #ff0000, #990000); color:#fff; box-shadow:0 3px 6px rgba(0,0,0,0.3); display:none; }

.dynamic-group { border:1px dashed #555; padding:12px; border-radius:8px; margin-top:12px; }
.dynamic-group h3 { color:#ff7518; margin-bottom:10px; }

#previewCard .preview-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #555; }
#previewCard .preview-row span.label { font-weight:600; color:#ccc; }
#previewCard .preview-row span.value { color:#fff; }

.status { margin-top:10px; padding:10px; border-radius:4px; text-align:center; font-weight:600; }
.status.error { background:#ff000033; color:#ff6666; border:1px solid #ff0000; }
.status.success { background:#00ff0033; color:#66ff66; border:1px solid #00ff00; }

/* ---------- Footer ---------- */
footer { width:100%; box-sizing:border-box; background-color:#1f1f1f; color:#fff; padding:25px 40px; font-family:Arial,sans-serif; border-top:1px solid #888; display:flex; justify-content:center; align-items:center; }
footer div { text-align:center; font-size:0.9rem; color:#ccc; display:flex; align-items:center; gap:6px; }
footer img.icon { height:2em; width:2em; animation: floatIcon 3s ease-in-out infinite alternate; }

@keyframes floatIcon { 0%{transform:translateY(0px);}50%{transform:translateY(-4px);}100%{transform:translateY(0px);} }

@media(max-width:600px){
  header { justify-content:center; padding:10px 15px; }
  header .spiderweb { display:none; }
  header h1 { text-align:center; font-size:1.2rem; }
  .header-links { display:none; }
  .hamburger { display:flex; position:absolute; left:15px; top:calc(50% - 9px); }
  #createCard { padding:15px; }
}
</style>
</head>
<body>

<script>
window.env = {
  env:'dev',
  ADMIN_URL:'https://dev-admin.spookydecs.com',
  MAIN_URL:'https://dev.spookydecs.com'
};
</script>

<header>
  <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  <div class="logo-title">
    <img src="https://assets.spookydecs.com/icons/frankenstein_icon.svg" alt="SpookyDecs Logo" class="icon">
    <h1>SpookyDecs Portal</h1>
  </div>
  <div class="header-links">
    <a href="#" id="link-admin" style="color:#fff;margin-right:12px;">Admin</a>
    <a href="#" id="link-main" style="color:#fff;margin-right:12px;">Main Site</a>
    <button id="signOutBtn">Sign Out</button>
    <img src="https://assets.spookydecs.com/icons/spiderweb_icon.svg" class="spiderweb">
  </div>
</header>

<div class="offcanvas" id="offcanvas">
  <button id="off-signout">Sign Out</button>
  <a href="#" id="off-admin-link">Return to Admin</a>
  <a href="#" id="off-main-link">Main Site</a>
  <div class="footer">&copy; 2025 SpookyDecs Network | Admin Portal</div>
</div>

<div class="container">
  <!-- Create Card -->
  <div id="createCard">
    <h2>Create New Item</h2>

    <div class="field-row">
      <label class="field-label" for="shortName">Short Name</label>
      <input type="text" id="shortName" required>
    </div>

    <div class="field-row">
      <label class="field-label" for="type">Type</label>
      <select id="type" required>
        <option value="">Select Type</option>
        <option value="INF">Inflatable</option>
        <option value="C">Cord</option>
        <option value="P">Plug</option>
        <option value="O">Outlet</option>
        <option value="STR_LT">String Light</option>
        <option value="SP_LT">Spot Light</option>
        <option value="PROP">Prop</option>
      </select>
    </div>

    <div class="field-row">
      <label class="field-label" for="category">Category</label>
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="Halloween">Halloween</option>
        <option value="Christmas">Christmas</option>
        <option value="Cord">Cord</option>
        <option value="Plug">Plug</option>
        <option value="Outlet">Outlet</option>
      </select>
    </div>

    <!-- Dynamic Fields -->
    <div id="dynamicFields"></div>

    <!-- ID Display -->
    <div class="field-row" id="idField" style="display:none;">
      <label class="field-label" for="generatedId">Generated ID</label>
      <input type="text" id="generatedId" readonly>
    </div>

    <!-- Buttons -->
    <div class="button-row">
      <button class="btn-primary" id="createBtn">Preview</button>
      <button class="btn-danger" id="cancelBtn">Cancel</button>
      <button class="btn-danger" id="clearBtn">Clear</button>
    </div>

    <div class="status" id="createStatus"></div>
  </div>
</div>

<!-- Modal overlay and preview card -->
<div id="modalOverlay"></div>
<div id="previewCard">
  <h2>Item Preview</h2>
  <div id="previewContent"></div>
  <div class="button-row" style="justify-content:center; gap:12px;">
    <button class="btn-danger" id="closePreviewBtn" style="display:inline-block;">Close Preview</button>
    <button class="btn-primary" id="finishBtn">Finish</button>
  </div>
</div>

<footer>
  <div>&copy; 2025 SpookyDecs Network | Admin Portal
    <img src="https://assets.spookydecs.com/icons/ghost_icon.svg" alt="Ghost Icon" class="icon">
  </div>
</footer>

<script>
// ============================================
// DOM ELEMENT REFERENCES
// ============================================
const modalOverlay = document.getElementById('modalOverlay');
const createBtn = document.getElementById('createBtn');
const cancelBtn = document.getElementById('cancelBtn');
const clearBtn = document.getElementById('clearBtn');
const dynamicFields = document.getElementById('dynamicFields');
const typeSelect = document.getElementById('type');
const idField = document.getElementById('idField');
const generatedId = document.getElementById('generatedId');
const status = document.getElementById('createStatus');
const previewCard = document.getElementById('previewCard');
const previewContent = document.getElementById('previewContent');
const closePreviewBtn = document.getElementById('closePreviewBtn');
const finishBtn = document.getElementById('finishBtn');

// ============================================
// FIELD DEFINITIONS
// ============================================
const fieldDefinitions = {
  INF: [
    {label:'Height / Length', type:'number', id:'height', min:1, required:true},
    {label:'Tethers', type:'number', id:'tethers', min:1, required:true},
    {label:'Stakes', type:'number', id:'stakes', min:1, required:true},
    {label:'Date Acquired', type:'number', id:'dateAcquired', min:1900, max:2099, required:true},
    {label:'Status', type:'select', id:'status', options:['','active','needs repair','packed','retired'], required:true},
    {label:'Image', type:'file', id:'image', required:false}
  ],
  C: [
    {label:'Length', type:'number', id:'length', min:1, required:true},
    {label:'Male Ends', type:'number', id:'maleEnds', min:1, required:true},
    {label:'Female Ends', type:'number', id:'femaleEnds', min:1, required:true}
  ],
  P: [
    {label:'Length', type:'number', id:'length', min:1, required:true},
    {label:'Male Ends', type:'number', id:'maleEnds', min:1, required:true},
    {label:'Female Ends', type:'number', id:'femaleEnds', min:1, required:true}
  ],
  O: [
    {label:'Receptacles', type:'number', id:'receptacles', min:1, required:true},
    {label:'Smart outlet', type:'select', id:'smartOutlet', options:['','True','False'], required:true}
  ],
  STR_LT: [
    {label:'Location', type:'select', id:'location', options:['','FY','SY','FN','TR'], required:true},
    {label:'Power Requirements', type:'text', id:'powerReq', required:true},
    {label:'LED Controller', type:'select', id:'ledController', options:['','True','False'], required:true},
    {label:'Color(s)', type:'text', id:'colors', required:true}
  ],
  SP_LT: [
    {label:'Power Requirements', type:'text', id:'powerReq', required:true},
    {label:'LED Controller', type:'select', id:'ledController', options:['','True','False'], required:true},
    {label:'Bulb Type', type:'select', id:'bulbType', options:['','PAR 38','Built-in'], required:true}
  ],
  PROP: [
    {label:'Description', type:'text', id:'description', required:true}
  ]
};

// ============================================
// HELPER FUNCTIONS
// ============================================

function showStatus(message, type = 'error') {
  status.innerText = message;
  status.className = `status ${type}`;
  status.style.display = 'block';
}

function clearStatus() {
  status.innerText = '';
  status.className = 'status';
  status.style.display = 'none';
}

function updateActionButtons() {
  const allInputs = document.querySelectorAll('#createCard input:not([readonly]), #createCard select, #dynamicFields input, #dynamicFields select');
  const hasData = Array.from(allInputs).some(input => input.value);
  
  cancelBtn.style.display = hasData ? 'inline-block' : 'none';
  clearBtn.style.display = hasData ? 'inline-block' : 'none';
}

function renderDynamicFields() {
  dynamicFields.innerHTML = '';
  clearStatus();
  
  const type = typeSelect.value;
  console.log('Rendering fields for type:', type);
  
  if(!type || !fieldDefinitions[type]) {
    console.log('No field definitions for type:', type);
    updateActionButtons();
    return;
  }

  const group = document.createElement('div');
  group.className = 'dynamic-group';
  
  const heading = document.createElement('h3');
  heading.innerText = 'Type Attributes';
  group.appendChild(heading);

  fieldDefinitions[type].forEach(field => {
    const row = document.createElement('div');
    row.className = 'field-row';
    
    const label = document.createElement('label');
    label.className = 'field-label';
    label.htmlFor = field.id;
    label.innerText = field.label;
    row.appendChild(label);

    let input;
    if(field.type === 'select'){
      input = document.createElement('select');
      field.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.text = opt;
        input.appendChild(option);
      });
    } else {
      input = document.createElement('input');
      input.type = field.type;
      if(field.min !== undefined) input.min = field.min;
      if(field.max !== undefined) input.max = field.max;
    }
    
    input.id = field.id;
    input.required = field.required;
    input.addEventListener('input', updateActionButtons);
    
    row.appendChild(input);
    group.appendChild(row);
  });

  dynamicFields.appendChild(group);
  console.log('Dynamic fields rendered successfully');
  updateActionButtons();
}

function closeModal() {
  previewCard.style.display = 'none';
  modalOverlay.style.display = 'none';
}

function resetForm() {
  const allInputs = document.querySelectorAll('#createCard input:not([readonly]), #createCard select');
  allInputs.forEach(el => {
    el.value = '';
    el.style.border = '1px solid #555';
  });
  dynamicFields.innerHTML = '';
  idField.style.display = 'none';
  clearStatus();
  updateActionButtons();
}

function getAllFormData() {
  const data = {
    shortName: document.getElementById('shortName').value,
    type: document.getElementById('type').value,
    category: document.getElementById('category').value
  };
  
  // Add dynamic fields
  const dynamicInputs = document.querySelectorAll('#dynamicFields input, #dynamicFields select');
  dynamicInputs.forEach(input => {
    if(input.value) {
      // Convert numbers appropriately
      if(input.type === 'number') {
        data[input.id] = parseInt(input.value) || parseFloat(input.value);
      } else if(input.type === 'file' && input.files[0]) {
        data[input.id] = input.files[0].name;
      } else {
        data[input.id] = input.value;
      }
    }
  });
  
  return data;
}

// ============================================
// EVENT LISTENERS
// ============================================

// Dynamic field rendering when type changes
typeSelect.addEventListener('change', renderDynamicFields);

// Update buttons on input
const staticInputs = document.querySelectorAll('#createCard input:not([readonly]), #createCard select');
staticInputs.forEach(input => input.addEventListener('input', updateActionButtons));

// Cancel button
cancelBtn.addEventListener('click', () => {
  resetForm();
  closeModal();
});

// Clear button
clearBtn.addEventListener('click', resetForm);

// Preview button
createBtn.addEventListener('click', () => {
  clearStatus();
  
  const type = typeSelect.value;
  if(!type) {
    showStatus('Please select a Type', 'error');
    return;
  }

  let valid = true;
  const allFields = document.querySelectorAll('#createCard input:not([readonly]), #createCard select, #dynamicFields input, #dynamicFields select');
  
  allFields.forEach(f => {
    if(f.required && !f.value) {
      f.style.border = '2px solid red';
      valid = false;
    } else {
      f.style.border = '1px solid #555';
    }
  });

  if(!valid) {
    showStatus('Please fill all required fields', 'error');
    return;
  }

  // Get all data
  const data = getAllFormData();

  // Generate ID placeholder
  const id = type + '-001';
  generatedId.value = id;
  idField.style.display = 'block';

  // Build preview
  previewContent.innerHTML = '';
  
  // Basic fields first
  const basicFields = [
    {key: 'shortName', label: 'Short Name'},
    {key: 'type', label: 'Type'},
    {key: 'category', label: 'Category'}
  ];
  
  basicFields.forEach(({key, label}) => {
    if(data[key]) {
      const row = document.createElement('div');
      row.className = 'preview-row';
      const labelSpan = document.createElement('span');
      labelSpan.className = 'label';
      labelSpan.innerText = label;
      const valueSpan = document.createElement('span');
      valueSpan.className = 'value';
      valueSpan.innerText = data[key];
      row.appendChild(labelSpan);
      row.appendChild(valueSpan);
      previewContent.appendChild(row);
    }
  });
  
  // Dynamic fields
  for(let key in data) {
    if(['shortName', 'type', 'category'].includes(key)) continue;
    
    const fieldDef = Object.values(fieldDefinitions).flat().find(f => f.id === key);
    const labelText = fieldDef ? fieldDef.label : key;
    
    const row = document.createElement('div');
    row.className = 'preview-row';
    const label = document.createElement('span');
    label.className = 'label';
    label.innerText = labelText;
    const value = document.createElement('span');
    value.className = 'value';
    value.innerText = data[key];
    row.appendChild(label);
    row.appendChild(value);
    previewContent.appendChild(row);
  }

  // Show modal
  modalOverlay.style.display = 'block';
  previewCard.style.display = 'flex';
});

// Close preview
closePreviewBtn.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', closeModal);

// Finish button - Submit to Lambda
finishBtn.addEventListener('click', async () => {
  try {
    // Gather all form data
    const formData = getAllFormData();

    console.log("Submitting item data:", formData);

    // Disable button
    finishBtn.disabled = true;
    finishBtn.textContent = "Submitting...";

    // Determine environment
    const env = window.env?.env || 'dev';
    const apiBase = env === 'prod'
      ? "https://miinu7boec.execute-api.us-east-2.amazonaws.com/prod"
      : "https://miinu7boec.execute-api.us-east-2.amazonaws.com/dev";

    console.log(`Using ${env} environment: ${apiBase}`);

    const response = await fetch(`${apiBase}/items`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(formData)
    });

    const result = await response.json();
    console.log("Lambda response:", result);

    if (!response.ok) {
      const errorMsg = result.error || result.message || 'Failed to create item';
      console.error('API Error:', errorMsg);
      alert(`❌ Error: ${errorMsg}`);
      return;
    }

    // Success
    const itemId = result.id || result.item?.id || generatedId.value;
    alert(`✅ Item created successfully!\nID: ${itemId}`);

    // Reset form
    resetForm();
    closeModal();

  } catch (err) {
    console.error("Error submitting item:", err);
    alert(`❌ Network error: ${err.message}`);
  } finally {
    finishBtn.disabled = false;
    finishBtn.textContent = "Finish";
  }
});

// Initialize
updateActionButtons();

console.log('Create form initialized successfully');
</script>
<!-- SAVE POINT THE CREATE WORKS!!-->
</body>
</html>