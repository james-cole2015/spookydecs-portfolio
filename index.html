<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin:0; padding:0; }
  .container { padding: 20px; }
  /* Login Form */
  #loginForm { max-width: 300px; margin: 50px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:10px;}
  #loginForm input { padding:8px; border-radius:4px; border:1px solid #ccc;}
  #loginForm button { padding:8px; border-radius:4px; border:none; background-color:#007bff; color:white; cursor:pointer;}
  #loginForm button:hover { opacity:0.9; }
  /* Dashboard */
  .admin-dashboard { display:none; flex-direction: column; gap: 20px; }
  .admin-dashboard h1 { font-size:2rem; margin-bottom:20px; }
  .admin-card { background-color:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:16px; display:flex; align-items:center; gap:16px; transition: box-shadow 0.2s ease; }
  .admin-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.15); }
  .icon-placeholder { width:40px; height:40px; background-color:#ccc; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:1rem; }
  .card-content h3 { margin:0 0 4px 0; font-size:1.2rem; }
  .card-content p { margin:0 0 8px 0; color:#555; }
  button { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; margin-right:8px; }
  button:hover { opacity:0.9; }
  .btn-primary { background-color:#007bff; color:white; }
  .btn-danger { background-color:#dc3545; color:white; }
  .search-input { padding:6px 10px; border-radius:4px; border:1px solid #ccc; width:100%; }
  .create-preview { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-top:12px; }
  .mini-card { padding:8px; border-radius:6px; background:#fafafa; display:flex; align-items:center; gap:12px; margin-bottom:8px; }
  .mini-card img { width:48px; height:48px; object-fit:cover; border-radius:4px; }
  .full-card img { max-width: 320px; height:auto; display:block; margin-bottom:8px; border-radius:6px; }
  .field-row { margin-bottom:6px; font-size:0.95rem; color:#333; }
  .field-label { font-weight:600; margin-right:6px; }
  .action-row { margin-top:10px; }
  @media (max-width: 768px) { .admin-card { flex-direction: column; align-items:flex-start; } }
</style>
</head>
<body>
<div class="container">

<!-- Login Form -->
<form id="loginForm">
  <h2>Admin Login</h2>
  <input type="text" id="username" placeholder="Username" required>
  <input type="password" id="password" placeholder="Password" required>
  <button type="submit">Login</button>
  <p id="loginError" style="color:red;"></p>
</form>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="admin-dashboard">
  <h1>Admin Dashboard</h1>

  <!-- Core Feature Cards -->
  <div class="admin-card"><div class="icon-placeholder">P</div><div class="card-content"><h3>Packing Process</h3><p>Scan tote â†’ scan items â†’ assign items â†’ confirm completion.</p><button class="btn-primary" onclick="startPacking()">Start Packing</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">C</div><div class="card-content"><h3>Create Item</h3><p>Prompt-driven item creation with image upload and preview.</p><button class="btn-primary" onclick="startCreateItem()">Create Item</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">U</div><div class="card-content"><h3>Update Item</h3><p>Edit item attributes or perform bulk updates.</p><button class="btn-primary" onclick="updateItems()">Update Items</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">D</div><div class="card-content"><h3>Delete Item</h3><p>Permanently delete or archive items.</p><button class="btn-danger" onclick="deleteItems()">Delete Items</button></div></div>

  <!-- Additional Feature Cards -->
  <div class="admin-card"><div class="icon-placeholder">T</div><div class="card-content"><h3>Tote Management</h3><p>Create, update, delete totes. Move items and track details.</p><button class="btn-primary" onclick="manageTotes()">Manage Totes</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">B</div><div class="card-content"><h3>Bulk Import / Export</h3><p>Import/export CSV/JSON, optional DynamoDB integration.</p><button class="btn-primary" onclick="bulkImportExport()">Import / Export</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">A</div><div class="card-content"><h3>Inventory Audit</h3><p>Filter items, check missing or duplicate items.</p><button class="btn-primary" onclick="inventoryAudit()">Audit Inventory</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">R</div><div class="card-content"><h3>Repair / Maintenance Tracker</h3><p>Track items needing repair; optional priority and notes.</p><button class="btn-primary" onclick="repairDashboard()">Repair Dashboard</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">H</div><div class="card-content"><h3>History / Audit Logs</h3><p>View user actions with timestamps.</p><button class="btn-primary" onclick="viewLogs()">View Logs</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">S</div><div class="card-content"><h3>Search & Filter</h3><p>Quick search and advanced filters.</p><input type="text" class="search-input" placeholder="Search items..."></div></div>
  <div class="admin-card"><div class="icon-placeholder">C</div><div class="card-content"><h3>Seasonal Prep / Cleanup</h3><p>Start season, archive old items, prep shopping list.</p><button class="btn-primary" onclick="startSeason()">Start Season</button><button class="btn-primary" onclick="archiveOldItems()">Archive Old Items</button><button class="btn-primary" onclick="prepShoppingList()">Prep Shopping List</button></div></div>
  <div class="admin-card"><div class="icon-placeholder">ðŸ“·</div><div class="card-content"><h3>Photo Management</h3><p>Upload and view photos of items and totes.</p><button class="btn-primary" onclick="managePhotos()">Manage Photos</button></div></div>

  <!-- Create Item Preview area -->
  <div id="createPreview" style="display:none;" class="create-preview">
    <div id="miniCard" class="mini-card"></div>
    <div id="fullCard" class="full-card"></div>
    <div class="action-row">
      <button id="editBtn" class="btn-primary">Edit</button>
      <button id="doneBtn" class="btn-primary">Done</button>
      <button id="cancelBtn" class="btn-danger">Cancel</button>
      <span id="createStatus" style="margin-left:12px;color:#333;"></span>
    </div>
  </div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@5.2.7/dist/amazon-cognito-identity.min.js"></script>
<script>
/* ---------- Cognito Setup ---------- */
const poolData = { 
  UserPoolId:'us-east-2_BnxSu5LEt',
  ClientId:'11er9f8qa7jkvgelm6hernb2ed'
};
const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const adminDashboard = document.getElementById('adminDashboard');

/* ---------- Check existing login ---------- */
window.addEventListener('load', () => {
  const token = localStorage.getItem('jwtToken');
  if (token) {
    loginForm.style.display = 'none';
    adminDashboard.style.display = 'flex';
  }
});

/* ---------- Handle login ---------- */
loginForm.addEventListener('submit', function(event){
  event.preventDefault();
  loginError.textContent = '';

  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({ Username: username, Password: password });
  const userData = { Username: username, Pool: userPool };
  const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

  cognitoUser.authenticateUser(authenticationDetails, {
    onSuccess: (result) => {
      const idToken = result.getIdToken().getJwtToken();
      localStorage.setItem('jwtToken', idToken);
      loginForm.style.display = 'none';
      adminDashboard.style.display = 'flex';
    },
    onFailure: (err) => {
      loginError.textContent = err.message || JSON.stringify(err);
    },
    newPasswordRequired: (userAttributes) => {
      delete userAttributes.email_verified;
      const newPassword = prompt("Please enter a new password:");
      cognitoUser.completeNewPasswordChallenge(newPassword, userAttributes, {
        onSuccess: (result) => {
          const idToken = result.getIdToken().getJwtToken();
          localStorage.setItem('jwtToken', idToken);
          loginForm.style.display = 'none';
          adminDashboard.style.display = 'flex';
        },
        onFailure: (err) => {
          loginError.textContent = err.message || JSON.stringify(err);
        },
      });
    },
  });
});

/* ---------- Utility Functions ---------- */
function getJwt() { return localStorage.getItem('jwtToken'); }
function getEmailFromJwt() {
  const token = getJwt();
  if(!token) return null;
  try { return JSON.parse(atob(token.split('.')[1])).email; } catch(e){ return null; }
}
function createHiddenFileInput(){
  const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment'; input.style.display='none'; document.body.appendChild(input); return input;
}

/* ---------- Create Item Flow with Authorization Headers ---------- */
const API_BASE = ''; // <-- Set your API Gateway base URL
const DEFAULT_STAGE = 'dev'; // or 'prod'

function getApiUrlForStage(stage){ return `${API_BASE}/${stage}`; }

async function startCreateItem(){
  const jwt = getJwt();
  if(!jwt){ alert('You must be logged in.'); return; }

  try {
    const attrs = {};
    attrs['Short Name'] = prompt('Short Name') || '';
    attrs['Category'] = prompt('Category') || '';
    attrs['Type'] = prompt('Type') || '';

    const fileInput = createHiddenFileInput();
    const filePromise = new Promise((resolve,reject)=>{fileInput.onchange=()=>fileInput.files[0]?resolve(fileInput.files[0]):reject('No file');fileInput.click();});
    const rawFile = await filePromise;
    fileInput.remove();

    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const bitmap=await createImageBitmap(rawFile);
    canvas.width=bitmap.width; canvas.height=bitmap.height; ctx.drawImage(bitmap,0,0); 
    const webpBlob = await new Promise(res=>canvas.toBlob(res,'image/webp',0.8));

    const payload = { attributes: attrs };

    const stage = DEFAULT_STAGE;
    const apiUrl = getApiUrlForStage(stage);

    // Create item record + get presigned URL
    const createResp = await fetch(`${apiUrl}/items`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${jwt}` },
      body: JSON.stringify(payload)
    });
    const { itemId, uploadUrl } = await createResp.json();

    // Upload image to presigned URL (with proper headers)
    await fetch(uploadUrl, { method:'PUT', headers:{'Content-Type':'image/webp'}, body:webpBlob });

    // Finalize image URL (PUT with Authorization header)
    await fetch(`${apiUrl}/items/${encodeURIComponent(itemId)}/image`, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${jwt}` },
      body: JSON.stringify({ imageUrl: uploadUrl.split('?')[0] })
    });

    document.getElementById('createPreview').style.display='block';
    document.getElementById('createStatus').textContent = `Created itemId: ${itemId}`;

  } catch(e){
    console.error('Create Item error:', e); alert('Create Item failed.');
  }
}

/* ---------- Placeholder functions (kept unchanged) ---------- */
function startPacking(){ alert("Start Packing clicked! Connect Lambda API here."); }
function updateItems(){ alert("Update Items clicked! Connect Lambda API here."); }
function deleteItems(){ alert("Delete Items clicked! Connect Lambda API here."); }
function manageTotes(){ alert("Manage Totes clicked! Connect Lambda API here."); }
function bulkImportExport(){ alert("Bulk Import/Export clicked! Connect Lambda API here."); }
function inventoryAudit(){ alert("Inventory Audit clicked! Connect Lambda API here."); }
function repairDashboard(){ alert("Repair Dashboard clicked! Connect Lambda API here."); }
function viewLogs(){ alert("View Logs clicked! Connect Lambda API here."); }
function startSeason(){ alert("Start Season clicked! Connect Lambda API here."); }
function archiveOldItems(){ alert("Archive Old Items clicked! Connect Lambda API here."); }
function prepShoppingList(){ alert("Prep Shopping List clicked! Connect Lambda API here."); }
function managePhotos(){ alert("Manage Photos clicked! Connect Lambda API here."); }
</script>

<footer>Â© 2025 spookydecs.com | Beware the 404s ðŸ‘»</footer>
</body>
</html>
